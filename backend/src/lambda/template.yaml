AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AI-Mon Backend API

  SAM Template for AI-Mon Lambda Functions

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs22.x
    LoggingConfig:
      LogFormat: JSON
    Environment:
      Variables:
        CLOUD_FRONT_API_SECRET_VALUE: !Ref CloudFrontSecretHeaderValue

Parameters:
  EnableBasicAuth:
    Type: String
    Description: "Enable Basic Authentication for CloudFront"
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
  EnableWAF:
    Type: String
    Description: "Enable WAF for CloudFront"
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  CloudFrontSecretHeaderValue:
    Type: String
    Description: "Secret value for CloudFront custom header"
    NoEcho: true
  ContentsBucketName:
    Type: String
  AppBucketName:
    Type: String
  AppBasePath:
    Type: String
  EnvPrefix:
    Type: String
    Description: "Environment prefix for resource names"
  UsersTableName:
    Type: String
    Description: The name of the DynamoDB table for users.
  SessionsTableName:
    Type: String
    Description: The name of the DynamoDB table for sessions.
  ScoresTableName:
    Type: String
    Description: The name of the DynamoDB table for scores.
  ResourcesTableName:
    Type: String
    Description: The name of the DynamoDB table for resources.
  QuizGroupsTableName:
    Type: String
    Description: The name of the DynamoDB table for quiz groups.
  QuestionsTableName:
    Type: String
    Description: The name of the DynamoDB table for questions.
  AimonSecretName:
    Type: String
    Description: The name of the secret containing application configurations.

Conditions:
  IsBasicAuthEnabled: !Equals [!Ref EnableBasicAuth, "true"]
  EnableWAFCondition: !Equals [!Ref EnableWAF, "false"]

Resources:
  SharedLogicLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ../nodejs/
      CompatibleRuntimes:
        - nodejs22.x
      Description: Shared utility functions for AI-Mon application.

  UsersRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersRegister/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersRegisterEvent:
          Type: Api
          Properties:
            Path: /users/register
            Method: post
#  UsersRegisterFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersRegisterFunction}
#      RetentionInDays: 1

  UsersLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersLogin/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersLoginEvent:
          Type: Api
          Properties:
            Path: /users/login
            Method: post
#  UsersLoginFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersLoginFunction}
#      RetentionInDays: 1

  UsersGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        UsersGetEvent:
          Type: Api
          Properties:
            Path: /users/get
            Method: get
#  UsersGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersGetFunction}
#      RetentionInDays: 1

  UsersLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersLogout/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersLogoutEvent:
          Type: Api
          Properties:
            Path: /users/logout
            Method: post
#  UsersLogoutFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersLogoutFunction}
#      RetentionInDays: 1

  UsersDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersDeleteEvent:
          Type: Api
          Properties:
            Path: /users/{userId}
            Method: delete
#  UsersDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersDeleteFunction}
#      RetentionInDays: 1

  QuizGroupsCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuizGroupsCreateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups
            Method: post
#  QuizGroupsCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsCreateFunction}
#      RetentionInDays: 1

  QuizGroupsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups
            Method: get
#  QuizGroupsListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsListFunction}
#      RetentionInDays: 1
  QuizGroupsListCacheFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups-list
            Method: get
#  QuizGroupsListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsListFunction}
#      RetentionInDays: 1

  QuizGroupsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsGetEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}
            Method: get
#  QuizGroupsGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsGetFunction}
#      RetentionInDays: 1

  QuizGroupsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsUpdate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuizGroupsUpdateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}
            Method: put
#  QuizGroupsUpdateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsUpdateFunction}
#      RetentionInDays: 1

  QuizGroupsDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuizGroupsDeleteEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}
            Method: delete
#  QuizGroupsDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsDeleteFunction}
#      RetentionInDays: 1

  QuestionsCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuestionsCreateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/questions
            Method: post
#  QuestionsCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsCreateFunction}
#      RetentionInDays: 1

  QuestionsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/questions
            Method: get
#  QuestionsListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsListFunction}
#      RetentionInDays: 1

  QuestionsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsGetEvent:
          Type: Api
          Properties:
            Path: /questions/{questionId}
            Method: get
#  QuestionsGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsGetFunction}
#      RetentionInDays: 1

  QuestionsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsUpdate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuestionsUpdateEvent:
          Type: Api
          Properties:
            Path: /questions/{questionId}
            Method: put
#  QuestionsUpdateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsUpdateFunction}
#      RetentionInDays: 1

  QuestionsDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuestionsDeleteEvent:
          Type: Api
          Properties:
            Path: /questions/{questionId}
            Method: delete
#  QuestionsDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsDeleteFunction}
#      RetentionInDays: 1

  AnswersSubmitFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: answersSubmit/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        AnswersSubmitEvent:
          Type: Api
          Properties:
            Path: /quizzes/{quizId}/answers
            Method: post
#  AnswersSubmitFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${AnswersSubmitFunction}
#      RetentionInDays: 1

  QuizCompletionFunction: # 追加された関数
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizCompletion/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
        
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizCompletionEvent:
          Type: Api
          Properties:
            Path: /quizzes/completion
            Method: post
#  QuizCompletionFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizCompletionFunction}
#      RetentionInDays: 1

  UserAnswerSelectionFunction: # 追加された関数
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: userAnswerSelection/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UserAnswerSelectionEvent:
          Type: Api
          Properties:
            Path: /quizzes/user-answer
            Method: post
#  UserAnswerSelectionFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UserAnswerSelectionFunction}
#      RetentionInDays: 1

  ResultsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resultsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResultsGetEvent:
          Type: Api
          Properties:
            Path: /results/{quizSessionId}
            Method: get
        ResultsGetCacheEvent:
          Type: Api
          Properties:
            Path: /answeredresults/{quizSessionId}
            Method: get
#  ResultsGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResultsGetFunction}
#      RetentionInDays: 1

  ScoreHistoryGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoreHistoryGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoreHistoryGetEvent:
          Type: Api
          Properties:
            Path: /scores
            Method: get
#  ScoreHistoryGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ScoreHistoryGetFunction}
#      RetentionInDays: 1

  ScoresCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoresCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoresCreateEvent:
          Type: Api
          Properties:
            Path: /scores
            Method: post
#  ScoresCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ScoresCreateFunction}
#      RetentionInDays: 1

  ScoresDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoresDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoresDeleteEvent:
          Type: Api
          Properties:
            Path: /scores/{quizSessionId}
            Method: delete
#  ScoresDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ScoresDeleteFunction}
#      RetentionInDays: 1

  PerformanceAnalysisGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: performanceAnalysisGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        PerformanceAnalysisGetEvent:
          Type: Api
          Properties:
            Path: /users/{userId}/performance-analysis
            Method: get
#  PerformanceAnalysisGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${PerformanceAnalysisGetFunction}
#      RetentionInDays: 1

  ResourcesCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ResourcesTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        ResourcesCreateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/resources
            Method: post
#  ResourcesCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResourcesCreateFunction}
#      RetentionInDays: 1

  ResourcesListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResourcesListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups-resources/{groupId}/
            Method: get
#  ResourcesListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResourcesListFunction}
#      RetentionInDays: 1

  ResourcesListAllFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesListAll/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
      Events:
        ResourcesListAllEvent:
          Type: Api
          Properties:
            Path: /resources/all
            Method: get

  ResourcesDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ResourcesTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        ResourcesDeleteEvent:
          Type: Api
          Properties:
            Path: /resources/{resourceId}
            Method: delete
#  ResourcesDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResourcesDeleteFunction}
#      RetentionInDays: 1

  AiGenerateQuestionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: aiGenerateQuestion/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
        - Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource:
              - !Sub "arn:aws:bedrock:ap-northeast-1::foundation-model/amazon.nova-lite-v1:0"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        AiGenerateQuestionEvent:
          Type: Api
          Properties:
            Path: /ai/generate-question
            Method: post
#  AiGenerateQuestionFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${AiGenerateQuestionFunction}
#      RetentionInDays: 1

  AiGenerateChoicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: aiGenerateChoices/
      Handler: app.lambdaHandler
      Timeout: 30
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
        - Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource:
              - !Sub "arn:aws:bedrock:ap-northeast-1::foundation-model/amazon.nova-lite-v1:0"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        AiGenerateChoicesEvent:
          Type: Api
          Properties:
            Path: /ai/generate-choices
            Method: post
#  AiGenerateChoicesFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${AiGenerateChoicesFunction}
#      RetentionInDays: 1

  UsersInactiveDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersInactiveDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersInactiveDeleteEvent:
          Type: Api
          Properties:
            Path: /users/inactive
            Method: delete
#  UsersInactiveDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersInactiveDeleteFunction}
#      RetentionInDays: 1

  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  # ApplicationInsightsMonitoring:
  #   Type: AWS::ApplicationInsights::Application
  #   Properties:
  #     ResourceGroupName:
  #       Ref: ApplicationResourceGroup
  #     AutoConfigurationEnabled: 'true'
  AimonOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub 'AimonOAC-${AWS::StackName}'
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontWebACL:
    Type: AWS::WAFv2::WebACL
    Condition: EnableWAFCondition
    Properties:
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      Rules:
        # レートリミットルール
        - Name: RateLimitRule
          Priority: 1
          Action:
            Block: {}
          Statement:
            RateLimitStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitMetric
            SampledRequestsEnabled: true
        # SQLインジェクション保護のマネージドルール
        - Name: AWS-AWSManagedRulesSQLiRuleSet
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet
          VisibilityConfig:
            CloudWatchMetricsEnabled: true
            MetricName: AWS-AWSManagedRulesSQLiRuleSet
            SampledRequestsEnabled: true
      VisibilityConfig:
        CloudWatchMetricsEnabled: true
        MetricName: CloudFrontWebACLMetrics
        SampledRequestsEnabled: true

  AimonCloudfront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        WebACLId: !If [EnableWAFCondition, !GetAtt CloudFrontWebACL.Arn, !Ref "AWS::NoValue"]
        Origins:
          - Id: AimonApiGatewayOrigin
            DomainName: !Sub '${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com'
            OriginCustomHeaders:
              - HeaderName: X-CloudFront-Secret
                HeaderValue: !Ref CloudFrontSecretHeaderValue
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
          - Id: AimonContentsS3Origin
            DomainName: !Sub '${ContentsBucketName}-${EnvPrefix}.s3.amazonaws.com'
            OriginAccessControlId: !GetAtt AimonOAC.Id
            S3OriginConfig:
              OriginAccessIdentity: ''
          - Id: AimonAppS3Origin
            DomainName: !Sub '${AppBucketName}-${EnvPrefix}.s3.amazonaws.com'
            OriginAccessControlId: !GetAtt AimonOAC.Id
            S3OriginConfig:
              OriginAccessIdentity: ''
        CacheBehaviors:
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/resources/all"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: &basicAuthFunctionIf !If
              - IsBasicAuthEnabled
              - - EventType: 'viewer-request'
                  FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
              - !Ref AWS::NoValue
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 600
            DefaultTTL: 600
            MaxTTL: 600
            ForwardedValues:
              QueryString: true
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/quiz-groups-resources/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: *basicAuthFunctionIf
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 600
            DefaultTTL: 600
            MaxTTL: 600
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/quiz-groups-list*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: *basicAuthFunctionIf
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 600
            DefaultTTL: 600
            MaxTTL: 600
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/answeredresults/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: *basicAuthFunctionIf
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 86400
            DefaultTTL: 604800
            MaxTTL: 2592000
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: *basicAuthFunctionIf
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 0
            DefaultTTL: 0
            MaxTTL: 0
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonContentsS3Origin
            PathPattern: "/contents/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: *basicAuthFunctionIf
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Referer
                - User-Agent
            MinTTL: 0
            DefaultTTL: 86400
            MaxTTL: 31536000
            SmoothStreaming: false
            Compress: true
          - TargetOriginId: AimonAppS3Origin
            PathPattern: !Sub "/${AppBasePath}/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations: *basicAuthFunctionIf
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Referer
                - User-Agent
            MinTTL: 0
            DefaultTTL: 86400
            MaxTTL: 31536000
            SmoothStreaming: false
            Compress: true
        DefaultCacheBehavior:
          TargetOriginId: AimonAppS3Origin
          ViewerProtocolPolicy: redirect-to-https
          FunctionAssociations: *basicAuthFunctionIf
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
            Headers:
              - Referer
              - User-Agent
          MinTTL: 0
          DefaultTTL: 86400
          MaxTTL: 31536000
          SmoothStreaming: false
          Compress: true
        CustomErrorResponses:
          - ErrorCode: 403
            ResponsePagePath: !Sub "/${AppBasePath}/index.html"
            ResponseCode: 200
            ErrorCachingMinTTL: 0
        Enabled: true
        HttpVersion: http2
        PriceClass: PriceClass_All

Outputs:
  ApiGatewayEndpoint:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  SharedLogicLayerArn:
    Description: "ARN of the shared logic Lambda Layer"
    Value: !Ref SharedLogicLayer
  AimonCloudfrontDomainName:
    Description: "Domain name of the CloudFront distribution"
    Value: !GetAtt AimonCloudfront.DomainName