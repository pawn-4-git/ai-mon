AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AI-Mon Backend API

  SAM Template for AI-Mon Lambda Functions

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs22.x
    LoggingConfig:
      LogFormat: JSON

Parameters:
  UsersTableName:
    Type: String
    Description: The name of the DynamoDB table for users.
    Default: UsersTable
  SessionsTableName:
    Type: String
    Description: The name of the DynamoDB table for sessions.
    Default: SessionsTable
  ScoresTableName:
    Type: String
    Description: The name of the DynamoDB table for scores.
    Default: ScoresTable
  ResourcesTableName:
    Type: String
    Description: The name of the DynamoDB table for resources.
    Default: ResourcesTable
  QuizGroupsTableName:
    Type: String
    Description: The name of the DynamoDB table for quiz groups.
    Default: QuizGroupsTable
  QuestionsTableName:
    Type: String
    Description: The name of the DynamoDB table for questions.
    Default: QuestionsTable
  AimonSecretName:
    Type: String
    Description: The name of the secret containing application configurations.
    Default: ai-mon-secret
  CloudFrontSecretHeaderValue:
    Type: String
    Description: The secret value for the X-CloudFront-Secret header.
    NoEcho: true

Resources:
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      Auth:
        DefaultAuthorizer: CustomAuthorizer
        Authorizers:
          CustomAuthorizer:
            FunctionArn: !GetAtt CustomAuthorizerFunction.Arn
            FunctionPayloadType: TOKEN
            Identity:
              Headers:
                - x-cloudfront-secret
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - "Content-Type"
        AllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
        MaxAge: 600

  CustomAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: customAuthorizer/
      Handler: app.lambdaHandler
      Runtime: nodejs22.x
      Timeout: 5
      Policies: []
      Environment:
        Variables:
          CLOUDFRONT_SECRET_HEADER: !Ref CloudFrontSecretHeaderValue

  SharedLogicLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ../nodejs/
      CompatibleRuntimes:
        - nodejs22.x
      Description: Shared utility functions for AI-Mon application.

  UsersRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersRegister/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersRegisterEvent:
          Type: HttpApi
          Properties:
            Path: /users/register
            Method: post
            ApiId: !Ref HttpApi
#  UsersRegisterFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersRegisterFunction}
#      RetentionInDays: 1

  UsersLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersLogin/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersLoginEvent:
          Type: HttpApi
          Properties:
            Path: /users/login
            Method: post
            ApiId: !Ref HttpApi            
#  UsersLoginFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersLoginFunction}
#      RetentionInDays: 1

  UsersGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        UsersGetEvent:
          Type: HttpApi
          Properties:
            Path: /users/get
            Method: get
            ApiId: !Ref HttpApi
#  UsersGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersGetFunction}
#      RetentionInDays: 1

  UsersLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersLogout/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersLogoutEvent:
          Type: HttpApi
          Properties:
            Path: /users/logout
            Method: post
            ApiId: !Ref HttpApi
#  UsersLogoutFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersLogoutFunction}
#      RetentionInDays: 1

  UsersDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersDeleteEvent:
          Type: HttpApi
          Properties:
            Path: /users/{userId}
            Method: delete
            ApiId: !Ref HttpApi
#  UsersDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersDeleteFunction}
#      RetentionInDays: 1

  QuizGroupsCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuizGroupsCreateEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups
            Method: post
            ApiId: !Ref HttpApi
#  QuizGroupsCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsCreateFunction}
#      RetentionInDays: 1

  QuizGroupsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsListEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups
            Method: get
            ApiId: !Ref HttpApi
#  QuizGroupsListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsListFunction}
#      RetentionInDays: 1
  QuizGroupsListCacheFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsListEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups-list
            Method: get
            ApiId: !Ref HttpApi
#  QuizGroupsListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsListFunction}
#      RetentionInDays: 1

  QuizGroupsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsGetEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups/{groupId}
            Method: get
            ApiId: !Ref HttpApi
#  QuizGroupsGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsGetFunction}
#      RetentionInDays: 1

  QuizGroupsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsUpdate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuizGroupsUpdateEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups/{groupId}
            Method: put
            ApiId: !Ref HttpApi
#  QuizGroupsUpdateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsUpdateFunction}
#      RetentionInDays: 1

  QuizGroupsDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuizGroupsDeleteEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups/{groupId}
            Method: delete
            ApiId: !Ref HttpApi
#  QuizGroupsDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizGroupsDeleteFunction}
#      RetentionInDays: 1

  QuestionsCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuestionsCreateEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups/{groupId}/questions
            Method: post
            ApiId: !Ref HttpApi
#  QuestionsCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsCreateFunction}
#      RetentionInDays: 1

  QuestionsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsListEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups/{groupId}/questions
            Method: get
            ApiId: !Ref HttpApi
#  QuestionsListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsListFunction}
#      RetentionInDays: 1

  QuestionsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsGetEvent:
          Type: HttpApi
          Properties:
            Path: /questions/{questionId}
            Method: get
            ApiId: !Ref HttpApi
#  QuestionsGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsGetFunction}
#      RetentionInDays: 1

  QuestionsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsUpdate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuestionsUpdateEvent:
          Type: HttpApi
          Properties:
            Path: /questions/{questionId}
            Method: put
            ApiId: !Ref HttpApi
#  QuestionsUpdateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsUpdateFunction}
#      RetentionInDays: 1

  QuestionsDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        QuestionsDeleteEvent:
          Type: HttpApi
          Properties:
            Path: /questions/{questionId}
            Method: delete
            ApiId: !Ref HttpApi
#  QuestionsDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuestionsDeleteFunction}
#      RetentionInDays: 1

  AnswersSubmitFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: answersSubmit/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        AnswersSubmitEvent:
          Type: HttpApi
          Properties:
            Path: /quizzes/{quizId}/answers
            Method: post
            ApiId: !Ref HttpApi
#  AnswersSubmitFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${AnswersSubmitFunction}
#      RetentionInDays: 1

  QuizCompletionFunction: # 追加された関数
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizCompletion/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
        
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizCompletionEvent:
          Type: HttpApi
          Properties:
            Path: /quizzes/completion
            Method: post
            ApiId: !Ref HttpApi
#  QuizCompletionFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${QuizCompletionFunction}
#      RetentionInDays: 1

  UserAnswerSelectionFunction: # 追加された関数
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: userAnswerSelection/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UserAnswerSelectionEvent:
          Type: HttpApi
          Properties:
            Path: /quizzes/user-answer
            Method: post
            ApiId: !Ref HttpApi
#  UserAnswerSelectionFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UserAnswerSelectionFunction}
#      RetentionInDays: 1

  ResultsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resultsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResultsGetEvent:
          Type: HttpApi
          Properties:
            Path: /results/{quizSessionId}
            Method: get
            ApiId: !Ref HttpApi
#  ResultsGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResultsGetFunction}
#      RetentionInDays: 1

  ScoreHistoryGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoreHistoryGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoreHistoryGetEvent:
          Type: HttpApi
          Properties:
            Path: /scores
            Method: get
            ApiId: !Ref HttpApi
#  ScoreHistoryGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ScoreHistoryGetFunction}
#      RetentionInDays: 1

  ScoresCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoresCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoresCreateEvent:
          Type: HttpApi
          Properties:
            Path: /scores
            Method: post
            ApiId: !Ref HttpApi
#  ScoresCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ScoresCreateFunction}
#      RetentionInDays: 1

  ScoresDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoresDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoresDeleteEvent:
          Type: HttpApi
          Properties:
            Path: /scores/{quizSessionId}
            Method: delete
            ApiId: !Ref HttpApi
#  ScoresDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ScoresDeleteFunction}
#      RetentionInDays: 1

  PerformanceAnalysisGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: performanceAnalysisGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        PerformanceAnalysisGetEvent:
          Type: HttpApi
          Properties:
            Path: /users/{userId}/performance-analysis
            Method: get
            ApiId: !Ref HttpApi
#  PerformanceAnalysisGetFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${PerformanceAnalysisGetFunction}
#      RetentionInDays: 1

  ResourcesCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ResourcesTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        ResourcesCreateEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups/{groupId}/resources
            Method: post
            ApiId: !Ref HttpApi
#  ResourcesCreateFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResourcesCreateFunction}
#      RetentionInDays: 1

  ResourcesListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResourcesListEvent:
          Type: HttpApi
          Properties:
            Path: /quiz-groups-resources/{groupId}/
            Method: get
            ApiId: !Ref HttpApi
#  ResourcesListFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResourcesListFunction}
#      RetentionInDays: 1

  ResourcesListAllFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesListAll/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
      Events:
        ResourcesListAllEvent:
          Type: HttpApi
          Properties:
            Path: /resources/all
            Method: get
            ApiId: !Ref HttpApi

  ResourcesDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref ResourcesTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        ResourcesDeleteEvent:
          Type: HttpApi
          Properties:
            Path: /resources/{resourceId}
            Method: delete
            ApiId: !Ref HttpApi
#  ResourcesDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${ResourcesDeleteFunction}
#      RetentionInDays: 1

  AiGenerateQuestionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: aiGenerateQuestion/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
        - Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource:
              - !Sub "arn:aws:bedrock:ap-northeast-1::foundation-model/amazon.nova-lite-v1:0"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        AiGenerateQuestionEvent:
          Type: HttpApi
          Properties:
            Path: /ai/generate-question
            Method: post
            ApiId: !Ref HttpApi
#  AiGenerateQuestionFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${AiGenerateQuestionFunction}
#      RetentionInDays: 1

  AiGenerateChoicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: aiGenerateChoices/
      Handler: app.lambdaHandler
      Timeout: 30
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AimonSecretName}-*"
        - Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource:
              - !Sub "arn:aws:bedrock:ap-northeast-1::foundation-model/amazon.nova-lite-v1:0"
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
          AIMON_SECRET_NAME: !Ref AimonSecretName
      Events:
        AiGenerateChoicesEvent:
          Type: HttpApi
          Properties:
            Path: /ai/generate-choices
            Method: post
            ApiId: !Ref HttpApi
#  AiGenerateChoicesFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${AiGenerateChoicesFunction}
#      RetentionInDays: 1

  UsersInactiveDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersInactiveDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersInactiveDeleteEvent:
          Type: HttpApi
          Properties:
            Path: /users/inactive
            Method: delete
            ApiId: !Ref HttpApi
#  UsersInactiveDeleteFunctionLogGroup:
#    Type: AWS::Logs::LogGroup
#    Properties:
#      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-${UsersInactiveDeleteFunction}
#      RetentionInDays: 1

  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  # ApplicationInsightsMonitoring:
  #   Type: AWS::ApplicationInsights::Application
  #   Properties:
  #     ResourceGroupName:
  #       Ref: ApplicationResourceGroup
  #     AutoConfigurationEnabled: 'true'
  AimonOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub 'AimonOAC-${AWS::StackName}'
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  AimonCloudfront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: AimonApiGatewayOrigin
            DomainName: !Sub '${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
            OriginCustomHeaders:
              - HeaderName: 'x-cloudfront-secret'
                HeaderValue: !Ref CloudFrontSecretHeaderValue
          - Id: AimonContentsS3Origin
            DomainName: !Sub 'ai-mon-contents-files.s3.amazonaws.com'
            OriginAccessControlId: !GetAtt AimonOAC.Id
            S3OriginConfig:
              OriginAccessIdentity: ''
          - Id: AimonAppS3Origin
            DomainName: !Sub 'ai-mon-app.s3.amazonaws.com'
            OriginAccessControlId: !GetAtt AimonOAC.Id
            S3OriginConfig:
              OriginAccessIdentity: ''
        CacheBehaviors:
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/resources/all"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations:
              - EventType: 'viewer-request'
                FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 600
            DefaultTTL: 600
            MaxTTL: 600
            ForwardedValues:
              QueryString: true
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/quiz-groups-resources/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations:
              - EventType: 'viewer-request'
                FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 600
            DefaultTTL: 600
            MaxTTL: 600
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod/quiz-groups-list*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations:
              - EventType: 'viewer-request'
                FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 600
            DefaultTTL: 600
            MaxTTL: 600
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonApiGatewayOrigin
            PathPattern: "/Prod*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations:
              - EventType: 'viewer-request'
                FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            MinTTL: 0
            DefaultTTL: 0
            MaxTTL: 0
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - username
                  - sessionId
                  - sessionVersionId
              Headers:
                - Accept
                - Accept-Language
                - Content-Language
                - Content-Type
                - Referer
                - User-Agent
                - X-Forwarded-For
                - X-Forwarded-Proto
          - TargetOriginId: AimonContentsS3Origin
            PathPattern: "/contents/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations:
              - EventType: 'viewer-request'
                FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Referer
                - User-Agent
            MinTTL: 0
            DefaultTTL: 86400
            MaxTTL: 31536000
            SmoothStreaming: false
            Compress: true
          - TargetOriginId: AimonAppS3Origin
            PathPattern: "/ai-mon/*"
            ViewerProtocolPolicy: redirect-to-https
            FunctionAssociations:
              - EventType: 'viewer-request'
                FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Referer
                - User-Agent
            MinTTL: 0
            DefaultTTL: 86400
            MaxTTL: 31536000
            SmoothStreaming: false
            Compress: true
        DefaultCacheBehavior:
          TargetOriginId: AimonAppS3Origin
          ViewerProtocolPolicy: redirect-to-https
          FunctionAssociations:
            - EventType: 'viewer-request'
              FunctionARN: !Sub "arn:aws:cloudfront::${AWS::AccountId}:function/basic_auth"
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
            Headers:
              - Referer
              - User-Agent
          MinTTL: 0
          DefaultTTL: 86400
          MaxTTL: 31536000
          SmoothStreaming: false
          Compress: true
        CustomErrorResponses:
          - ErrorCode: 403
            ResponsePagePath: /ai-mon/index.html
            ResponseCode: 200
            ErrorCachingMinTTL: 0
        Enabled: true
        HttpVersion: http2
        PriceClass: PriceClass_All

Outputs:
  ApiGatewayEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/"
  SharedLogicLayerArn:
    Description: "ARN of the shared logic Lambda Layer"
    Value: !Ref SharedLogicLayer
  AimonCloudfrontDomainName:
    Description: "Domain name of the CloudFront distribution"
    Value: !GetAtt AimonCloudfront.DomainName