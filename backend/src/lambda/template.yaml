AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AI-Mon Backend API

  SAM Template for AI-Mon Lambda Functions

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs22.x
    LoggingConfig:
      LogFormat: JSON

Parameters:
  UsersTableName:
    Type: String
    Description: The name of the DynamoDB table for users.
    Default: UsersTable
  SessionsTableName:
    Type: String
    Description: The name of the DynamoDB table for sessions.
    Default: SessionsTable
  ScoresTableName:
    Type: String
    Description: The name of the DynamoDB table for scores.
    Default: ScoresTable
  ResourcesTableName:
    Type: String
    Description: The name of the DynamoDB table for resources.
    Default: ResourcesTable
  QuizGroupsTableName:
    Type: String
    Description: The name of the DynamoDB table for quiz groups.
    Default: QuizGroupsTable
  QuestionsTableName:
    Type: String
    Description: The name of the DynamoDB table for questions.
    Default: QuestionsTable

Resources:
  SharedLogicLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ../nodejs/
      CompatibleRuntimes:
        - nodejs22.x
      Description: Shared utility functions for AI-Mon application.

  UsersRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersRegister/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersRegisterEvent:
          Type: Api
          Properties:
            Path: /users/register
            Method: post
            # CORS設定を追加
            RestApiId: !Ref MyApi

  UsersLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersLogin/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersLoginEvent:
          Type: Api
          Properties:
            Path: /users/login
            Method: post
            RestApiId: !Ref MyApi

  UsersLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersLogout/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersLogoutEvent:
          Type: Api
          Properties:
            Path: /users/logout
            Method: post
            RestApiId: !Ref MyApi

  UsersDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersDeleteEvent:
          Type: Api
          Properties:
            Path: /users/{userId}
            Method: delete
            RestApiId: !Ref MyApi

  QuizGroupsCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsCreateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups
            Method: post
            RestApiId: !Ref MyApi

  QuizGroupsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups
            Method: get
            RestApiId: !Ref MyApi

  QuizGroupsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsGetEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}
            Method: get
            RestApiId: !Ref MyApi

  QuizGroupsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsUpdate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsUpdateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}
            Method: put
            RestApiId: !Ref MyApi

  QuizGroupsDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: quizGroupsDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuizGroupsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuizGroupsDeleteEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}
            Method: delete
            RestApiId: !Ref MyApi

  QuestionsCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsCreateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/questions
            Method: post
            RestApiId: !Ref MyApi

  QuestionsListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/questions
            Method: get
            RestApiId: !Ref MyApi

  QuestionsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsGetEvent:
          Type: Api
          Properties:
            Path: /questions/{questionId}
            Method: get
            RestApiId: !Ref MyApi

  QuestionsUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsUpdate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsUpdateEvent:
          Type: Api
          Properties:
            Path: /questions/{questionId}
            Method: put
            RestApiId: !Ref MyApi

  QuestionsDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: questionsDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        QuestionsDeleteEvent:
          Type: Api
          Properties:
            Path: /questions/{questionId}
            Method: delete
            RestApiId: !Ref MyApi

  AnswersSubmitFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: answersSubmit/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        AnswersSubmitEvent:
          Type: Api
          Properties:
            Path: /quizzes/{quizId}/answers
            Method: post
            RestApiId: !Ref MyApi

  ResultsGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resultsGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResultsGetEvent:
          Type: Api
          Properties:
            Path: /quizzes/{quizId}/results
            Method: get
            RestApiId: !Ref MyApi

  ScoreHistoryGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoreHistoryGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoreHistoryGetEvent:
          Type: Api
          Properties:
            Path: /users/{userId}/score-history
            Method: get
            RestApiId: !Ref MyApi

  ScoresCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoresCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoresCreateEvent:
          Type: Api
          Properties:
            Path: /users/{userId}/scores
            Method: post
            RestApiId: !Ref MyApi

  ScoresDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: scoresDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ScoresDeleteEvent:
          Type: Api
          Properties:
            Path: /scores/{scoreId}
            Method: delete
            RestApiId: !Ref MyApi

  PerformanceAnalysisGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: performanceAnalysisGet/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ScoresTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        PerformanceAnalysisGetEvent:
          Type: Api
          Properties:
            Path: /users/{userId}/performance-analysis
            Method: get
            RestApiId: !Ref MyApi

  ResourcesCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesCreate/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResourcesCreateEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/resources
            Method: post
            RestApiId: !Ref MyApi

  ResourcesListFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesList/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBReadPolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResourcesListEvent:
          Type: Api
          Properties:
            Path: /quiz-groups/{groupId}/resources
            Method: get
            RestApiId: !Ref MyApi

  ResourcesDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: resourcesDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref ResourcesTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        ResourcesDeleteEvent:
          Type: Api
          Properties:
            Path: /resources/{resourceId}
            Method: delete
            RestApiId: !Ref MyApi

  AiGenerateQuestionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: aiGenerateQuestion/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        AiGenerateQuestionEvent:
          Type: Api
          Properties:
            Path: /ai/generate-question
            Method: post
            RestApiId: !Ref MyApi

  AiGenerateChoicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: aiGenerateChoices/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        AiGenerateChoicesEvent:
          Type: Api
          Properties:
            Path: /ai/generate-choices
            Method: post
            RestApiId: !Ref MyApi

  UsersInactiveDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref SharedLogicLayer
      CodeUri: usersInactiveDelete/
      Handler: app.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTableName
        - DynamoDBWritePolicy:
            TableName: !Ref UsersTableName
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          SESSIONS_TABLE_NAME: !Ref SessionsTableName
          SCORES_TABLE_NAME: !Ref ScoresTableName
          RESOURCES_TABLE_NAME: !Ref ResourcesTableName
          QUIZ_GROUPS_TABLE_NAME: !Ref QuizGroupsTableName
          QUESTIONS_TABLE_NAME: !Ref QuestionsTableName
      Events:
        UsersInactiveDeleteEvent:
          Type: Api
          Properties:
            Path: /users/inactive
            Method: delete
            RestApiId: !Ref MyApi

  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: 'true'

Outputs:
  ApiGatewayEndpoint:
    Description: API Gateway endpoint URL for Prod stage
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  SharedLogicLayerArn:
    Description: "ARN of the shared logic Lambda Layer"
    Value: !Ref SharedLogicLayer

# API Gateway のリソース定義に CORS 設定を追加
MyApi:
  Type: AWS::Serverless::Api
  Properties:
    StageName: Prod
    Cors:
      AllowMethods: "POST,GET,OPTIONS,PUT,DELETE"
      AllowHeaders: "Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token"
      AllowOrigin: "http://localhost:3000,https://your-app.com"
      # AllowCredentials: true # 必要に応じてコメント解除